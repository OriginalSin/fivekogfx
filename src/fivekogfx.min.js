/*
 Copyright (c) 2017 fiveko.com
 See the LICENSE file for copying permission.
*/
function FivekoGFX(h){function c(b){try{return b.getContext("webgl",{premultipliedAlpha:!1})||b.getContext("experimental-webgl",{premultipliedAlpha:!1})}catch(a){console.log("ERROR: %o",a)}return null}function e(b,a){var d=new XMLHttpRequest;d.open("GET",b,!1);d.onreadystatechange=function(){4!==d.readyState||200!==d.status&&0!=d.status||a(d.responseText);return a("")};d.send(null)}function f(b){var a=b.createTexture();b.bindTexture(b.TEXTURE_2D,a);b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!0);b.texParameteri(b.TEXTURE_2D,
b.TEXTURE_MIN_FILTER,b.LINEAR);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE);return a}function g(b,a,d){var m=b.getAttribLocation(a,"a_position"),f=b.getUniformLocation(a,"u_image");b.getUniformLocation(a,"u_matrix");a=b.getUniformLocation(a,"u_textureSize");b.vertexAttribPointer(m,2,b.FLOAT,!1,0,0);b.enableVertexAttribArray(m);var m=b.canvas.width,c=b.canvas.height;
b.bindFramebuffer(b.FRAMEBUFFER,d);b.uniform2f(a,m,c);b.uniform1i(f,0);b.viewport(0,0,m,c);b.drawArrays(b.TRIANGLES,0,6)}this.gl=h?c(h):c(document.createElement("canvas"));this.params={};this.programs={};this.sources={};FivekoGFX.prototype.createProgram=function(b,a,d){function f(b,a){var d=c.createShader(b);c.shaderSource(d,a);c.compileShader(d);return c.getShaderParameter(d,c.COMPILE_STATUS)?d:(alert("An error occurred compiling the shaders: "+c.getShaderInfoLog(d)),null)}var c=this.gl,e=this.programs[b];
if(e)return e;d=d?f(c.VERTEX_SHADER,d):f(c.VERTEX_SHADER,"attribute vec2 a_position;                     \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tvoid main() { gl_Position = vec4(a_position, 0.0, 1.0); }");a=f(c.FRAGMENT_SHADER,a);e=c.createProgram();c.attachShader(e,d);c.attachShader(e,a);c.linkProgram(e);c.getProgramParameter(e,c.LINK_STATUS)?this.programs[b]=e:alert("Unable to initialize the shader program.");return e};FivekoGFX.prototype.createProgramFromFile=function(b,a,d,c){e(a,function(a){""!==a?
(a=createProgram(b,a),c(a)):c(null)})};FivekoGFX.prototype.deleteProgram=function(b){var a=this.gl,d=this.programs[b];d&&(a.deleteProgram(d),this.programs[b]=null)};FivekoGFX.prototype.initialize=function(b,a){var d=this.gl,c=d.canvas;if(!this.originalImageTexture||c.width!=b||c.height!=a){c.width=b;c.height=a;this.originalImageTexture=f(d);for(var e=[],g=[],h=0;2>h;++h){var k=f(d);e.push(k);d.texImage2D(d.TEXTURE_2D,0,d.RGBA,c.width,c.height,0,d.RGBA,d.UNSIGNED_BYTE,null);var l=d.createFramebuffer();
g.push(l);d.bindFramebuffer(d.FRAMEBUFFER,l);d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,k,0)}c=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,c);d.bufferData(d.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),d.STATIC_DRAW);this.textures=e;this.framebuffers=g;this.count=0}};FivekoGFX.prototype.load=function(b){var a=this.gl;this.initialize(b.width,b.height);var d=window.performance.now();a.bindTexture(a.TEXTURE_2D,this.originalImageTexture);a.texImage2D(a.TEXTURE_2D,
0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,b);console.log("Image loaded!Elapsed: "+(window.performance.now()-d).toString())};FivekoGFX.prototype.loadOLD=function(b){var a=this.gl,d=window.performance.now();var c=f(a);var e=a.canvas,g=(480<document.documentElement.clientWidth?480:document.documentElement.clientWidth-100)/Math.max(b.width,b.height);e.width=g*b.width;e.height=g*b.height;g=document.createElement("canvas");g.width=e.width;g.height=e.height;g.getContext("2d").drawImage(b,0,0,g.width,g.height);console.log("Texture created!");
a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,g);this.originalImageTexture=c;console.log("Image loaded!Elapsed: "+(window.performance.now()-d).toString());b=[];d=[];for(g=0;2>g;++g){c=f(a);b.push(c);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,e.width,e.height,0,a.RGBA,a.UNSIGNED_BYTE,null);var h=a.createFramebuffer();d.push(h);a.bindFramebuffer(a.FRAMEBUFFER,h);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,c,0)}c=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,c);a.bufferData(a.ARRAY_BUFFER,
new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),a.STATIC_DRAW);a.bindTexture(a.TEXTURE_2D,this.originalImageTexture);this.textures=b;this.framebuffers=d;this.count=0};FivekoGFX.prototype.renderto=function(b,a){g(this.gl,b,a)};FivekoGFX.prototype.draw=function(b){var a=this.gl,d=this.createProgram("draw","precision mediump float;                                   \r\n\t\t\t\t\t\t\t\t\t\t\t\t\tuniform sampler2D u_image;                                  \r\n\t\t\t\t\t\t\t\t\t\t\t\t\tuniform vec2 u_textureSize;                                 \r\n\t\t\t\t\t\t\t\t\t\t\t\t\tvoid main() {                                               \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tvec2 textCoord = gl_FragCoord.xy / u_textureSize;       \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tgl_FragColor = texture2D(u_image, textCoord/*vec2(textCoord.x, 1.0 - textCoord.y)*/ );          \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t}                                                           ");
a.useProgram(d);g(a,d,null);this.count=0;b&&b.getContext("2d").drawImage(a.canvas,0,0)};FivekoGFX.prototype.readPixels=function(b){var a=this.gl;b||(b={data:new Uint8Array(a.canvas.width*a.canvas.height*4),width:a.canvas.width,height:a.canvas.height});a.readPixels(0,0,a.canvas.width,a.canvas.height,a.RGBA,a.UNSIGNED_BYTE,b.data);return b};FivekoGFX.prototype.execute=function(b){var a=this.gl;g(a,b,this.framebuffers[this.count%2]);a.bindTexture(a.TEXTURE_2D,this.textures[this.count%2]);++this.count}}
FivekoGFX.params={};FivekoGFX.sources={};FivekoGFX.sourceText=function(h,c){return FivekoGFX.sources[h]};
FivekoGFX.prototype.loadShaders=function(h){function c(b,a){var d=document.getElementById(a);if(!d)return null;var c="",e=d.firstChild;for(console.log(b);e;)e.nodeType==e.TEXT_NODE&&(c+=e.textContent),e=e.nextSibling;if("x-shader/x-fragment"==d.type)d=b.createShader(b.FRAGMENT_SHADER);else if("x-shader/x-vertex"==d.type)d=b.createShader(b.VERTEX_SHADER);else return null;b.shaderSource(d,c);b.compileShader(d);return b.getShaderParameter(d,b.COMPILE_STATUS)?d:(alert("An error occurred compiling the shaders: "+
b.getShaderInfoLog(d)),null)}var e=this.gl,f=c(e,h[0]);h=c(e,h[1]);var g=e.createProgram();e.attachShader(g,h);e.attachShader(g,f);e.linkProgram(g);e.getProgramParameter(g,e.LINK_STATUS)||alert("Unable to initialize the shader program.");return g};(function(h){function c(c,f){var e=c.gl,b=c.createProgram("sobel","\nprecision mediump float;\n\n#define KERNEL_SIZE 3\n// our texture\nuniform sampler2D u_image;\nuniform vec2 u_textureSize;\nuniform float u_kernel[KERNEL_SIZE];\n#define M_PI 3.1415926535897932384626433832795\n#define GET_PIXEL(_x, _y) (texture2D(u_image, textCoord + onePixel*vec2(_x, _y)))\n \n\nvoid main() {\n\tvec2 onePixel = vec2(1.0, 1.0) / u_textureSize;\n\tvec2 textCoord = gl_FragCoord.xy / u_textureSize;\n\tfloat dx = (length(GET_PIXEL(-1, -1)*u_kernel[0] +\n\t\t\t\tGET_PIXEL(-1,  0)*u_kernel[1] +\n\t\t\t\tGET_PIXEL(-1, +1)*u_kernel[2]) -\n\t\t\t   length(GET_PIXEL(+1, -1)*u_kernel[0] +\n\t\t\t\tGET_PIXEL(+1,  0)*u_kernel[1] +\n\t\t\t\tGET_PIXEL(+1, +1)*u_kernel[2]));\n\tfloat dy = (length(GET_PIXEL(-1, -1)*u_kernel[0] +\n\t\t\t\tGET_PIXEL(0, -1)*u_kernel[1] +\n\t\t\t\tGET_PIXEL(+1, -1)*u_kernel[2]) -\n\t\t\t   length(GET_PIXEL(-1, +1)*u_kernel[0] +\n\t\t\t\tGET_PIXEL(0, +1)*u_kernel[1] +\n\t\t\t\tGET_PIXEL(+1, +1)*u_kernel[2]));\n\n///gl_FragColor = vec4(vec3(length(vec2(dx, dy))), 1.0);\n   float theta = (atan(dy, dx) + M_PI) / (2.0*M_PI);\n   vec3 v = vec3(length(vec2(dx, dy)));\n   gl_FragColor = vec4(v, 1.0);\n}");
e.useProgram(b);var a=e.getUniformLocation(b,"u_kernel[0]");e.uniform1fv(a,f);c.execute(b)}h.prototype.sobel=function(){c(this,[1,2,1])};h.prototype.schaar=function(){c(this,[3,10,3])}})(window.FivekoGFX);(function(h){h.prototype.gauss=function(c){var e=this.gl,f=this.params.gauss;if(!f||f.sigma!==c){var f=Math.sqrt(2*Math.PI)*c,g=0,b=2*c*c,a,d=new Float32Array(15);var h=0;for(a=-7;15>h;a++,h++)d[h]=Math.exp(-(a*a)/b)/f,g+=d[h];for(a=0;15>a;a++)d[a]/=g;f={sigma:c,kernel:d};this.params.gauss=f}c=this.createProgram("gauss","\nprecision mediump float;\n\n// our texture\nuniform sampler2D u_image;\n\n#define KERNEL_SIZE 15\nuniform vec2 u_textureSize;\nuniform int u_direction;\nuniform float u_kernel[KERNEL_SIZE];\nvoid main() {\n\tvec2 textCoord = gl_FragCoord.xy / u_textureSize;\n\tvec2 onePixel = ((u_direction == 0) ? vec2(1.0, 0.0) : vec2(0.0, 1.0)) / u_textureSize;\n\tvec4 meanColor = vec4(0);\n\tint ms = KERNEL_SIZE / 2;\n\tfor (int i = 0; i < KERNEL_SIZE; i++)\n\t{\n\t\tmeanColor += texture2D(u_image, textCoord  + onePixel*vec2(i - ms))*u_kernel[i];\n\t}\n\tgl_FragColor = meanColor;\n}");
g=f.kernel;e.useProgram(c);b=e.getUniformLocation(c,"u_kernel[0]");f=e.getUniformLocation(c,"u_direction");e.uniform1fv(b,g);for(g=0;2>g;g++)e.uniform1i(f,g),this.execute(c)}})(window.FivekoGFX);(function(h){h.sources.mean="\nprecision mediump float;\n\n// our texture\nuniform sampler2D u_image;\nuniform vec2 u_textureSize;\nvoid main() {\n\tvec2 textCoord = gl_FragCoord.xy / u_textureSize;\n\tvec2 onePixel = vec2(1.0, 1.0) / u_textureSize;\n\tgl_FragColor = (\n\t\ttexture2D(u_image, textCoord + onePixel*vec2(-1.0, -1.0)) + \n\t\ttexture2D(u_image, textCoord + onePixel*vec2(0.0, -1.0)) + \n\t\ttexture2D(u_image, textCoord + onePixel*vec2(1.0, -1.0)) + \n\t\ttexture2D(u_image, textCoord + onePixel*vec2(-1.0, 0.0)) + \n\t\ttexture2D(u_image, textCoord + onePixel*vec2(0.0,  0.0)) + \n\t\ttexture2D(u_image, textCoord + onePixel*vec2(1.0,  0.0)) + \n\t\ttexture2D(u_image, textCoord + onePixel*vec2(-1.0, 1.0)) + \n\t\ttexture2D(u_image, textCoord + onePixel*vec2(0.0,  1.0)) + \n\t\ttexture2D(u_image, textCoord + onePixel*vec2(1.0,  1.0))) / 9.0;\n}";
h.prototype.mean=function(){var c=this.gl,e=this.createProgram("mean","\nprecision mediump float;\n\n// our texture\nuniform sampler2D u_image;\nuniform vec2 u_textureSize;\nvoid main() {\n\tvec2 textCoord = gl_FragCoord.xy / u_textureSize;\n\tvec2 onePixel = vec2(1.0, 1.0) / u_textureSize;\n\tgl_FragColor = (\n\t\ttexture2D(u_image, textCoord + onePixel*vec2(-1.0, -1.0)) + \n\t\ttexture2D(u_image, textCoord + onePixel*vec2(0.0, -1.0)) + \n\t\ttexture2D(u_image, textCoord + onePixel*vec2(1.0, -1.0)) + \n\t\ttexture2D(u_image, textCoord + onePixel*vec2(-1.0, 0.0)) + \n\t\ttexture2D(u_image, textCoord + onePixel*vec2(0.0,  0.0)) + \n\t\ttexture2D(u_image, textCoord + onePixel*vec2(1.0,  0.0)) + \n\t\ttexture2D(u_image, textCoord + onePixel*vec2(-1.0, 1.0)) + \n\t\ttexture2D(u_image, textCoord + onePixel*vec2(0.0,  1.0)) + \n\t\ttexture2D(u_image, textCoord + onePixel*vec2(1.0,  1.0))) / 9.0;\n}");
c.useProgram(e);this.execute(e)};h.prototype.blur=function(c){c=12*c*c/8;var e=this.gl,f=this.createProgram("mean","\nprecision mediump float;\n\n// our texture\nuniform sampler2D u_image;\nuniform vec2 u_textureSize;\nvoid main() {\n\tvec2 textCoord = gl_FragCoord.xy / u_textureSize;\n\tvec2 onePixel = vec2(1.0, 1.0) / u_textureSize;\n\tgl_FragColor = (\n\t\ttexture2D(u_image, textCoord + onePixel*vec2(-1.0, -1.0)) + \n\t\ttexture2D(u_image, textCoord + onePixel*vec2(0.0, -1.0)) + \n\t\ttexture2D(u_image, textCoord + onePixel*vec2(1.0, -1.0)) + \n\t\ttexture2D(u_image, textCoord + onePixel*vec2(-1.0, 0.0)) + \n\t\ttexture2D(u_image, textCoord + onePixel*vec2(0.0,  0.0)) + \n\t\ttexture2D(u_image, textCoord + onePixel*vec2(1.0,  0.0)) + \n\t\ttexture2D(u_image, textCoord + onePixel*vec2(-1.0, 1.0)) + \n\t\ttexture2D(u_image, textCoord + onePixel*vec2(0.0,  1.0)) + \n\t\ttexture2D(u_image, textCoord + onePixel*vec2(1.0,  1.0))) / 9.0;\n}");
e.useProgram(f);for(e=0;e<c;e++)this.execute(f)}})(window.FivekoGFX);(function(h){h.prototype.symmetricnn=function(c,e){var f=this.params.symmetricnn;f&&f.size!==c&&this.deleteProgram("symmetricnn");this.params.symmetricnn={size:c};var g=this.gl,f=this.createProgram("symmetricnn","\nprecision mediump float;\n\n// our texture\nuniform sampler2D u_image;\nuniform vec2 u_textureSize;\nuniform int u_pixelsCount;\n#define KERNEL_SIZE %kernelSize%\n#define HALF_SIZE (KERNEL_SIZE / 2)\n\nvoid main() {\n\tvec2 textCoord = gl_FragCoord.xy / u_textureSize;\n\tvec2 onePixel = vec2(1.0, 1.0) / u_textureSize;\n\tvec4 meanColor = vec4(0);\n\tvec4 v = texture2D(u_image, textCoord);\n\tint count = 0;\n\tfor (int y = 0; y <= HALF_SIZE; y++){\n\t\tfor (int x = -HALF_SIZE; x <= HALF_SIZE; x++){\n\t\t\tvec4 v1 = texture2D(u_image, textCoord + vec2(x, y) * onePixel);  \n\t\t\tvec4 v2 = texture2D(u_image, textCoord + vec2(-x, -y) * onePixel);\n\t\t\tvec4 d1 = abs(v - v1);\n\t\t\tvec4 d2 = abs(v - v2);\n\t\t\tvec4 rv = vec4(((d1[0] < d2[0]) ? v1[0] : v2[0]),\n\t\t\t\t\t\t\t((d1[1] < d2[1]) ? v1[1] : v2[1]),\n\t\t\t\t\t\t\t((d1[2] < d2[2]) ? v1[2] : v2[2]),1);\n\t\t\tmeanColor += rv;\n\t\t}\n\t}\n\tgl_FragColor = meanColor / float(u_pixelsCount);\n}".replace(/%kernelSize%/g,
c));g.useProgram(f);var b=(c+!(c%2))*((c+!(c%2))/2+.5),a=g.getUniformLocation(f,"u_pixelsCount");g.uniform1i(a,b);console.log("size:"+c+" count: "+b);for(g=0;g<e;g++)this.execute(f)}})(window.FivekoGFX);(function(h){h.prototype.houghCircle=function(c){var e=this.gl,f=this.createProgram("houghCircle","\nprecision mediump float;\n\n// our texture\nuniform sampler2D u_image;\nuniform vec2 u_textureSize;\nuniform float u_r;\n#define M_PI 3.1415926535897932384626433832795\n#define PHI_STEP M_PI/180.0\n\nvoid main() {\n\tvec2 onePixel = vec2(1.0, 1.0) / u_textureSize;\n\tvec2 textCoord = gl_FragCoord.xy / u_textureSize;\n\tvec4 sum = vec4(0.0);\n\tfloat phi = 0.0;\n\tfor (int i = 0; i < 360; i++)\n\t{\n\t\tphi += PHI_STEP;\n\t\tsum += texture2D(u_image, textCoord + onePixel*vec2(u_r*cos(phi), u_r*sin(phi)));\n\t}\n\t\n\tgl_FragColor = vec4(vec3(sum / 360.0), 1.0);\n}");
e.useProgram(f);e.uniform1f(e.getUniformLocation(f,"u_r"),c);this.execute(f)}})(window.FivekoGFX);(function(h){function c(c,g){function b(a,b){return d[a+1]-d[b+1]}function a(a){for(var c=0;4>c;c++){var e=a+q[c];if(0===d[e]){d[e]=d[a];var g=f[a+0]+f[e+0]>>>1,k=f[a+0]-f[e+0],l=f[a+1]-f[e+1],m=f[a+2]-f[e+2];d[e+1]=Math.sqrt(((512+g)*k*k>>8)+4*l*l+((767-g)*m*m>>8));h.push(e,b)}}}for(var d=new c.data.constructor(new ArrayBuffer(c.data.length)),f=c.data,h=new e,q=[-4,4,4*-c.width,4*c.width],n=4*c.width,k=0,l=n*c.height;k<n;k+=4)d[k]=d[k+l]=255;k=0;for(l=c.height*n;k<l;k+=n)d[k]=d[k+n-1]=255;k=0;for(l=
g.length;g[k];k++)for(var l=g[k].pixels,p=0,r=l.length;p<r;p++)d[l[p]]=80*(k+1),a(l[p]);for(;!h.empty();)l=h.pop(),a(l);k=n+4;for(l=n*c.height-n;k<l;k+=4)160==d[k]&&(f[k+1]=f[k+2]=255*q.reduce(function(a,b){return a|d[k]^d[k+b]},0))}var e=function(){this.nodes=[]};e.prototype.push=function(c,e){for(var b=this.nodes,a=0,d=b.length;a<d;){var f=a+d>>>1;0>e(c,b[f])?a=f+1:d=f}b.splice(a,0,c)};e.prototype.pop=function(){return this.nodes.pop()};e.prototype.empty=function(){return 0===this.nodes.length};
e.prototype.size=function(){return this.nodes.length};h.prototype.watershed=function(e,g){var b=e.getContext("2d"),a=b.getImageData(0,0,e.width,e.height);c(a,g);b.putImageData(a,0,0)}})(window.FivekoGFX);
